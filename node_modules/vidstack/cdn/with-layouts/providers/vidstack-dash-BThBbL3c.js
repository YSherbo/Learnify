import{T as m,a as A,l as D,p as M}from"../chunks/vidstack-By-MVw1B.js";import{h as q,f as _,I as R,j as F}from"../chunks/vidstack-CyRzesiL.js";import{VideoProvider as I}from"./vidstack-video-DYDFbW3C.js";import{l as T,e as N,D as l,a as P,i as u,v as $,k as w,a6 as K,p as C}from"../chunks/vidstack-CfWjVwmq.js";import{Q as v}from"../chunks/vidstack-dclo3F73.js";import{L as b}from"../chunks/vidstack-ClIUVQwo.js";import{R as j}from"../chunks/vidstack-HiX0s9nm.js";import{c as O}from"../chunks/vidstack-BkhPaOZP.js";import"./vidstack-html-ItCkf05R.js";import"../chunks/vidstack-Bxv1Qnxe.js";import"../chunks/vidstack-dYA3SKom.js";function E(a){try{return new Intl.DisplayNames(navigator.languages,{type:"language"}).of(a)??null}catch{return null}}const H=a=>`dash-${$(a)}`;class Q{constructor(t,i){this.m=t,this.b=i,this.d=null,this.qb=null,this.rb={},this.sb=new Set,this.Kb=null,this.oe={},this.na=-1}get instance(){return this.d}setup(t){this.d=t().create();const i=this.Ii.bind(this);for(const s of Object.values(t.events))this.d.on(s,i);this.d.on(t.events.ERROR,this.Q.bind(this));for(const s of this.sb)s(this.d);this.b.player.dispatch("dash-instance",{detail:this.d}),this.d.initialize(this.m,void 0,!1),this.d.updateSettings({streaming:{text:{defaultEnabled:!1,dispatchForManualRendering:!0},buffer:{fastSwitchEnabled:!0}},...this.rb}),this.d.on(t.events.FRAGMENT_LOADING_STARTED,this.Ji.bind(this)),this.d.on(t.events.FRAGMENT_LOADING_COMPLETED,this.Ki.bind(this)),this.d.on(t.events.MANIFEST_LOADED,this.Li.bind(this)),this.d.on(t.events.QUALITY_CHANGE_RENDERED,this.Za.bind(this)),this.d.on(t.events.TEXT_TRACKS_ADDED,this.Mi.bind(this)),this.d.on(t.events.TRACK_CHANGE_RENDERED,this.pc.bind(this)),this.b.qualities[v.Ia]=this.je.bind(this),T(this.b.qualities,"change",this.ke.bind(this)),T(this.b.audioTracks,"change",this.le.bind(this)),this.qb=N(this.me.bind(this))}aa(t){return new l(H(t.type),{detail:t})}me(){if(!this.b.$state.live())return;const t=new j(this.ne.bind(this));return t.Xa(),t.$.bind(t)}ne(){if(!this.d)return;const t=this.d.duration()-this.d.time();this.b.$state.liveSyncPosition.set(isNaN(t)?1/0:t)}Ii(t){this.b.player?.dispatch(this.aa(t))}Ni(t){const i=this.Kb?.[m._],s=(i?.track).cues;if(!i||!s)return;const r=this.Kb.id,n=this.oe[r]??0,o=this.aa(t);for(let c=n;c<s.length;c++){const h=s[c];h.positionAlign||(h.positionAlign="auto"),this.Kb.addCue(h,o)}this.oe[r]=s.length}Mi(t){if(!this.d)return;const i=t.tracks,s=[...this.m.textTracks].filter(n=>"manualMode"in n),r=this.aa(t);for(let n=0;n<s.length;n++){const o=i[n],c=s[n],h=`dash-${o.kind}-${n}`,d=new A({id:h,label:o?.label??o.labels.find(g=>g.text)?.text??(o?.lang&&E(o.lang))??o?.lang??void 0,language:o.lang??void 0,kind:o.kind,default:o.defaultTrack});d[m._]={managed:!0,track:c},d[m.ma]=2,d[m.hb]=()=>{this.d&&(d.mode==="showing"?(this.d.setTextTrack(n),this.Kb=d):(this.d.setTextTrack(-1),this.Kb=null))},this.b.textTracks.add(d,r)}}pc(t){const{mediaType:i,newMediaInfo:s}=t;if(i==="audio"){const r=this.b.audioTracks.getById(`dash-audio-${s.index}`);if(r){const n=this.aa(t);this.b.audioTracks[b.ea](r,!0,n)}}}Za(t){if(t.mediaType!=="video")return;const i=this.b.qualities[t.newQuality];if(i){const s=this.aa(t);this.b.qualities[b.ea](i,!0,s)}}Li(t){if(this.b.$state.canPlay()||!this.d)return;const{type:i,mediaPresentationDuration:s}=t.data,r=this.aa(t);this.b.delegate.c("stream-type-change",i!=="static"?"live":"on-demand",r),this.b.delegate.c("duration-change",s,r),this.b.qualities[v.Wa](!0,r);const n=this.d.getVideoElement(),o=this.d.getTracksForTypeFromManifest("video",t.data),c=[...new Set(o.map(e=>e.mimeType))].find(e=>e&&q(n,e)),h=o.filter(e=>c===e.mimeType)[0];let d=this.d.getTracksForTypeFromManifest("audio",t.data);const g=[...new Set(d.map(e=>e.mimeType))].find(e=>e&&_(n,e));if(d=d.filter(e=>g===e.mimeType),h.bitrateList.forEach((e,p)=>{const f={id:e.id?.toString()??`dash-bitrate-${p}`,width:e.width??0,height:e.height??0,bitrate:e.bandwidth??0,codec:h.codec,index:p};this.b.qualities[b.da](f,r)}),P(h.index)){const e=this.b.qualities[h.index];e&&this.b.qualities[b.ea](e,!0,r)}d.forEach((e,p)=>{const f=e.labels.find(y=>navigator.languages.some(x=>y.lang&&x.toLowerCase().startsWith(y.lang.toLowerCase())))||e.labels[0],k={id:`dash-audio-${e?.index}`,label:f?.text??(e.lang&&E(e.lang))??e.lang??"",language:e.lang??"",kind:"main",mimeType:e.mimeType,codec:e.codec,index:p};this.b.audioTracks[b.da](k,r)}),n.dispatchEvent(new l("canplay",{trigger:r}))}Q(t){const{type:i,error:s}=t;switch(s.code){case 27:this.pe(s);break;default:this.qc(s);break}}Ji(){this.na>=0&&this._a()}Ki(t){t.mediaType==="text"&&requestAnimationFrame(this.Ni.bind(this,t))}pe(t){this._a(),this.d?.play(),this.na=window.setTimeout(()=>{this.na=-1,this.qc(t)},5e3)}_a(){clearTimeout(this.na),this.na=-1}qc(t){this.b.delegate.c("error",{message:t.message??"",code:1,error:t})}je(){this.lg("video",!0);const{qualities:t}=this.b;this.d?.setQualityFor("video",t.selectedIndex,!0)}lg(t,i){this.d?.updateSettings({streaming:{abr:{autoSwitchBitrate:{[t]:i}}}})}ke(){const{qualities:t}=this.b;!this.d||t.auto||!t.selected||(this.lg("video",!1),this.d.setQualityFor("video",t.selectedIndex,t.switch==="current"),R&&(this.m.currentTime=this.m.currentTime))}le(){if(!this.d)return;const{audioTracks:t}=this.b,i=this.d.getTracksFor("audio").find(s=>t.selected&&t.selected.id===`dash-audio-${s.index}`);i&&this.d.setCurrentTrack(i)}z(){this._a(),this.Kb=null,this.oe={}}loadSource(t){this.z(),u(t.src)&&this.d?.attachSource(t.src)}destroy(){this.z(),this.d?.destroy(),this.d=null,this.qb?.(),this.qb=null}}class G{constructor(t,i,s){this.L=t,this.b=i,this.La=s,this.qe()}async qe(){const t={onLoadStart:this.Ma.bind(this),onLoaded:this.tb.bind(this),onLoadError:this.re.bind(this)};let i=await V(this.L,t);return w(i)&&!u(this.L)&&(i=await z(this.L,t)),i?window.dashjs.supportsMediaSource()?i:(this.b.player.dispatch(new l("dash-unsupported")),this.b.delegate.c("error",{message:"[vidstack] `dash.js` is not supported in this environment",code:4}),null):null}Ma(){this.b.player.dispatch(new l("dash-lib-load-start"))}tb(t){this.b.player.dispatch(new l("dash-lib-loaded",{detail:t})),this.La(t)}re(t){const i=O(t);this.b.player.dispatch(new l("dash-lib-load-error",{detail:i})),this.b.delegate.c("error",{message:i.message,code:4,error:i})}}async function z(a,t={}){if(!w(a)){if(t.onLoadStart?.(),B(a))return t.onLoaded?.(a),a;if(L(a)){const i=a.MediaPlayer;return t.onLoaded?.(i),i}try{const i=(await a())?.default;if(L(i))return t.onLoaded?.(i.MediaPlayer),i.MediaPlayer;if(i)t.onLoaded?.(i);else throw Error("");return i}catch(i){t.onLoadError?.(i)}}}async function V(a,t={}){if(u(a)){t.onLoadStart?.();try{if(await D(a),!K(window.dashjs.MediaPlayer))throw Error("");const i=window.dashjs.MediaPlayer;return t.onLoaded?.(i),i}catch(i){t.onLoadError?.(i)}}}function B(a){return a&&a.prototype&&a.prototype!==Function}function L(a){return a&&"MediaPlayer"in a}const J="https://cdn.jsdelivr.net";class S extends I{constructor(){super(...arguments),this.$$PROVIDER_TYPE="DASH",this.rc=null,this.e=new Q(this.video,this.b),this.oa=`${J}/npm/dashjs@4.7.4/dist/dash.all.min.js`}get ctor(){return this.rc}get instance(){return this.e.instance}get type(){return"dash"}get canLiveSync(){return!0}get config(){return this.e.rb}set config(t){this.e.rb=t}get library(){return this.oa}set library(t){this.oa=t}preconnect(){u(this.oa)&&M(this.oa)}setup(){super.setup(),new G(this.oa,this.b,t=>{this.rc=t,this.e.setup(t),this.b.delegate.c("provider-setup",this);const i=C(this.b.$state.source);i&&this.loadSource(i)})}async loadSource(t,i){if(!u(t.src)){this.oc();return}this.a.preload=i||"",this.ge(t,"application/x-mpegurl"),this.e.loadSource(t),this.K=t}onInstance(t){const i=this.e.instance;return i&&t(i),this.e.sb.add(t),()=>this.e.sb.delete(t)}destroy(){this.e.destroy()}}S.supported=F();export{S as DASHProvider};
