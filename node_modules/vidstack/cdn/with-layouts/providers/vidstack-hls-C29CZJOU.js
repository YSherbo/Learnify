import{a as E,T as m,l as v,p as y}from"../chunks/vidstack-By-MVw1B.js";import{I as S,l as k}from"../chunks/vidstack-CyRzesiL.js";import{VideoProvider as w}from"./vidstack-video-DYDFbW3C.js";import{p,l as f,e as _,D as c,i as l,v as q,k as g,a6 as I}from"../chunks/vidstack-CfWjVwmq.js";import{Q as L}from"../chunks/vidstack-dclo3F73.js";import{L as u}from"../chunks/vidstack-ClIUVQwo.js";import{R}from"../chunks/vidstack-HiX0s9nm.js";import{c as $}from"../chunks/vidstack-BkhPaOZP.js";import"./vidstack-html-ItCkf05R.js";import"../chunks/vidstack-Bxv1Qnxe.js";import"../chunks/vidstack-dYA3SKom.js";const O=r=>q(r);class x{constructor(t,i){this.m=t,this.b=i,this.d=null,this.qb=null,this.rb={},this.sb=new Set,this.na=-1}get instance(){return this.d}setup(t){const{streamType:i}=this.b.$state,s=p(i).includes("live"),e=p(i).includes("ll-");this.d=new t({lowLatencyMode:e,backBufferLength:e?4:s?8:void 0,renderTextTracksNatively:!1,...this.rb});const n=this.Oi.bind(this);for(const a of Object.values(t.Events))this.d.on(a,n);this.d.on(t.Events.ERROR,this.Q.bind(this));for(const a of this.sb)a(this.d);this.b.player.dispatch("hls-instance",{detail:this.d}),this.d.attachMedia(this.m),this.d.on(t.Events.FRAG_LOADING,this.Pi.bind(this)),this.d.on(t.Events.AUDIO_TRACK_SWITCHED,this.Qi.bind(this)),this.d.on(t.Events.LEVEL_SWITCHED,this.Ri.bind(this)),this.d.on(t.Events.LEVEL_LOADED,this.Si.bind(this)),this.d.on(t.Events.NON_NATIVE_TEXT_TRACKS_FOUND,this.Ti.bind(this)),this.d.on(t.Events.CUES_PARSED,this.Ui.bind(this)),this.b.qualities[L.Ia]=this.je.bind(this),f(this.b.qualities,"change",this.ke.bind(this)),f(this.b.audioTracks,"change",this.le.bind(this)),this.qb=_(this.me.bind(this))}aa(t,i){return new c(O(t),{detail:i})}me(){if(!this.b.$state.live())return;const t=new R(this.ne.bind(this));return t.Xa(),t.$.bind(t)}ne(){this.b.$state.liveSyncPosition.set(this.d?.liveSyncPosition??1/0)}Oi(t,i){this.b.player?.dispatch(this.aa(t,i))}Ti(t,i){const s=this.aa(t,i);let e=-1;for(let n=0;n<i.tracks.length;n++){const a=i.tracks[n],h=a.subtitleTrack??a.closedCaptions,d=new E({id:`hls-${a.kind}-${n}`,src:h?.url,label:a.label,language:h?.lang,kind:a.kind,default:a.default});d[m.ma]=2,d[m.hb]=()=>{d.mode==="showing"?(this.d.subtitleTrack=n,e=n):e===n&&(this.d.subtitleTrack=-1,e=-1)},this.b.textTracks.add(d,s)}}Ui(t,i){const s=this.d?.subtitleTrack,e=this.b.textTracks.getById(`hls-${i.type}-${s}`);if(!e)return;const n=this.aa(t,i);for(const a of i.cues)a.positionAlign="auto",e.addCue(a,n)}Qi(t,i){const s=this.b.audioTracks[i.id];if(s){const e=this.aa(t,i);this.b.audioTracks[u.ea](s,!0,e)}}Ri(t,i){const s=this.b.qualities[i.level];if(s){const e=this.aa(t,i);this.b.qualities[u.ea](s,!0,e)}}Si(t,i){if(this.b.$state.canPlay())return;const{type:s,live:e,totalduration:n,targetduration:a}=i.details,h=this.aa(t,i);this.b.delegate.c("stream-type-change",e?s==="EVENT"&&Number.isFinite(n)&&a>=10?"live:dvr":"live":"on-demand",h),this.b.delegate.c("duration-change",n,h);const d=this.d.media;this.d.currentLevel===-1&&this.b.qualities[L.Wa](!0,h);for(const o of this.d.audioTracks){const b={id:o.id.toString(),label:o.name,language:o.lang||"",kind:"main"};this.b.audioTracks[u.da](b,h)}for(const o of this.d.levels){const b={id:o.id?.toString()??o.height+"p",width:o.width,height:o.height,codec:o.codecSet,bitrate:o.bitrate};this.b.qualities[u.da](b,h)}d.dispatchEvent(new c("canplay",{trigger:h}))}Q(t,i){if(i.fatal)switch(i.type){case"networkError":this.pe(i.error);break;case"mediaError":this.d?.recoverMediaError();break;default:this.qc(i.error);break}}Pi(){this.na>=0&&this._a()}pe(t){this._a(),this.d?.startLoad(),this.na=window.setTimeout(()=>{this.na=-1,this.qc(t)},5e3)}_a(){clearTimeout(this.na),this.na=-1}qc(t){this.b.delegate.c("error",{message:t.message,code:1,error:t})}je(){this.d&&(this.d.currentLevel=-1)}ke(){const{qualities:t}=this.b;!this.d||t.auto||(this.d[t.switch+"Level"]=t.selectedIndex,S&&(this.m.currentTime=this.m.currentTime))}le(){const{audioTracks:t}=this.b;this.d&&this.d.audioTrack!==t.selectedIndex&&(this.d.audioTrack=t.selectedIndex)}Vi(t){this._a(),l(t.src)&&this.d?.loadSource(t.src)}Wi(){this._a(),this.d?.destroy(),this.d=null,this.qb?.(),this.qb=null}}class D{constructor(t,i,s){this.L=t,this.b=i,this.La=s,this.qe()}async qe(){const t={onLoadStart:this.Ma.bind(this),onLoaded:this.tb.bind(this),onLoadError:this.re.bind(this)};let i=await C(this.L,t);return g(i)&&!l(this.L)&&(i=await A(this.L,t)),i?i.isSupported()?i:(this.b.player.dispatch(new c("hls-unsupported")),this.b.delegate.c("error",{message:"[vidstack] `hls.js` is not supported in this environment",code:4}),null):null}Ma(){this.b.player.dispatch(new c("hls-lib-load-start"))}tb(t){this.b.player.dispatch(new c("hls-lib-loaded",{detail:t})),this.La(t)}re(t){const i=$(t);this.b.player.dispatch(new c("hls-lib-load-error",{detail:i})),this.b.delegate.c("error",{message:i.message,code:4,error:i})}}async function A(r,t={}){if(!g(r)){if(t.onLoadStart?.(),r.prototype&&r.prototype!==Function)return t.onLoaded?.(r),r;try{const i=(await r())?.default;if(i&&i.isSupported)t.onLoaded?.(i);else throw Error("");return i}catch(i){t.onLoadError?.(i)}}}async function C(r,t={}){if(l(r)){t.onLoadStart?.();try{if(await v(r),!I(window.Hls))throw Error("");const i=window.Hls;return t.onLoaded?.(i),i}catch(i){t.onLoadError?.(i)}}}const H="https://cdn.jsdelivr.net";class T extends w{constructor(){super(...arguments),this.$$PROVIDER_TYPE="HLS",this.rc=null,this.e=new x(this.video,this.b),this.oa=`${H}/npm/hls.js@^1.5.0/dist/hls.min.js`}get ctor(){return this.rc}get instance(){return this.e.instance}get type(){return"hls"}get canLiveSync(){return!0}get config(){return this.e.rb}set config(t){this.e.rb=t}get library(){return this.oa}set library(t){this.oa=t}preconnect(){l(this.oa)&&y(this.oa)}setup(){super.setup(),new D(this.oa,this.b,t=>{this.rc=t,this.e.setup(t),this.b.delegate.c("provider-setup",this);const i=p(this.b.$state.source);i&&this.loadSource(i)})}async loadSource(t,i){if(!l(t.src)){this.oc();return}this.a.preload=i||"",this.ge(t,"application/x-mpegurl"),this.e.Vi(t),this.K=t}onInstance(t){const i=this.e.instance;return i&&t(i),this.e.sb.add(t),()=>this.e.sb.delete(t)}destroy(){this.e.Wi()}}T.supported=k();export{T as HLSProvider};
